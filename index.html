<!doctype html>
<html lang="ko" style="height: 100%;">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìˆ˜í–‰í‰ê°€ ì ìˆ˜ ê²€ì¦</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; }
    @media print {
      .print\:hidden { display: none !important; }
      .print\:border-2 { border-width: 2px !important; }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
</head>
<body style="height: 100%; margin: 0; font-family: 'Noto Sans KR', sans-serif;">
  <div id="app" class="w-full h-full bg-gradient-to-br from-blue-50 to-indigo-100 overflow-auto">
    <div class="max-w-6xl mx-auto p-6">
      <h1 id="pageTitle" class="text-4xl font-bold text-indigo-900 mb-8 text-center">ìˆ˜í–‰í‰ê°€ ì ìˆ˜ ê²€ì¦</h1>
      <!-- ê³¼ëª© ë° ìˆ˜í–‰í‰ê°€ ì„ íƒ -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-2xl font-semibold text-indigo-800 mb-4">ê³¼ëª© ë° ìˆ˜í–‰í‰ê°€ ì„ íƒ</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label for="subjectSelect" class="block text-sm font-medium text-gray-700 mb-2">ê³¼ëª©</label>
            <select id="subjectSelect" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
              <option value="">-- ê³¼ëª© ì„ íƒ --</option>
              <option value="êµ­ì–´">êµ­ì–´</option>
              <option value="ì˜ì–´">ì˜ì–´</option>
              <option value="ìˆ˜í•™">ìˆ˜í•™</option>
              <option value="ì‚¬íšŒ">ì‚¬íšŒ</option>
              <option value="ê³¼í•™">ê³¼í•™</option>
              <option value="ë„ë•">ë„ë•</option>
              <option value="ê¸°ìˆ ê°€ì •">ê¸°ìˆ ê°€ì •</option>
              <option value="ì²´ìœ¡">ì²´ìœ¡</option>
              <option value="ìŒì•…">ìŒì•…</option>
              <option value="ë¯¸ìˆ ">ë¯¸ìˆ </option>
              <option value="í•œë¬¸">í•œë¬¸</option>
            </select>
          </div>
          <div>
            <label for="assessmentInput" class="block text-sm font-medium text-gray-700 mb-2">ìˆ˜í–‰í‰ê°€ëª…</label>
            <input type="text" id="assessmentInput" placeholder="ì˜ˆ: 1í•™ê¸° ì¤‘ê°„í‰ê°€" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
          </div>
          <div>
            <label for="gradeSelect" class="block text-sm font-medium text-gray-700 mb-2">í•™ë…„</label>
            <select id="gradeSelect" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg">
              <option value="">-- í•™ë…„ ì„ íƒ --</option>
              <option value="1">1í•™ë…„</option>
              <option value="2">2í•™ë…„</option>
              <option value="3">3í•™ë…„</option>
            </select>
          </div>
          <div>
            <label for="classCountInput" class="block text-sm font-medium text-gray-700 mb-2">ë§ˆì§€ë§‰ ë°˜(ì˜ˆ: 8)</label>
            <input type="number" id="classCountInput" min="1" max="20" placeholder="ì˜ˆ: 8" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg">
          </div>
          <div>
            <label for="studentNumInput" class="block text-sm font-medium text-gray-700 mb-2">ë§ˆì§€ë§‰ ë²ˆí˜¸(ì˜ˆ: 35, í•œ ë°˜ì— ìµœëŒ€ ëª‡ ë²ˆê¹Œì§€ ìˆëŠ”ì§€)</label>
            <input type="number" id="studentNumInput" min="1" max="60" placeholder="ì˜ˆ: 28" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg">
          </div>
        </div>
        <div class="flex gap-2">
          <button id="newAssessmentBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200"> ìƒˆ í‰ê°€ ë§Œë“¤ê¸° </button>
          <button id="loadAssessmentBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200"> ì €ì¥ëœ í‰ê°€ ë¶ˆëŸ¬ì˜¤ê¸° </button>
        </div>
        <div id="currentAssessment" class="mt-4 hidden">
          <div class="bg-indigo-50 border-2 border-indigo-300 rounded-lg p-4">
            <div class="font-bold text-lg text-indigo-900" id="currentAssessmentTitle"></div>
            <div class="text-sm text-gray-600 mt-1" id="currentAssessmentInfo"></div>
          </div>
        </div>
      </div>
      <!-- ì €ì¥ëœ í‰ê°€ ëª©ë¡ -->
      <div id="savedAssessmentsSection" class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-2xl font-semibold text-indigo-800 mb-4">ì €ì¥ëœ í‰ê°€ ëª©ë¡</h2>
        <div id="savedAssessmentsList" class="space-y-2"></div>
        <div id="emptyAssessments" class="text-gray-500 text-center py-4">
          ì €ì¥ëœ í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
      </div>
      <!-- ë‹¨ê³„ë³„ ì±„ì ê¸°ì¤€ ì…ë ¥ -->
      <div id="criteriaSection" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden">
        <h2 class="text-2xl font-semibold text-indigo-800 mb-4">ë‹¨ê³„ë³„ ì±„ì ê¸°ì¤€ ì„¤ì •</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div>
            <label for="maxScore" class="block text-sm font-medium text-gray-700 mb-2">ìµœê³ ì </label>
            <input type="number" id="maxScore" placeholder="ì˜ˆ: 60" min="0" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
          </div>
          <div>
            <label for="minScore" class="block text-sm font-medium text-gray-700 mb-2">ìµœì €ì </label>
            <input type="number" id="minScore" placeholder="ì˜ˆ: 20" min="0" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
          </div>
          <div>
            <label for="interval" class="block text-sm font-medium text-gray-700 mb-2">ê¸‰ê°„ (ì ìˆ˜ ê°„ê²©)</label>
            <input type="number" id="interval" placeholder="ì˜ˆ: 10" min="0" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
          </div>
        </div>
        <button id="addStepBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 mb-4">
          ë‹¨ê³„ ì¶”ê°€
        </button>
        <!-- ë“±ë¡ëœ ë‹¨ê³„ ëª©ë¡ -->
        <div id="stepsList" class="space-y-2 mb-4"></div>
        <!-- ê°€ëŠ¥í•œ ì´ì  í‘œì‹œ -->
        <div id="possibleScores" class="mt-4"></div>
        <!-- ì €ì¥ ë²„íŠ¼ -->
        <button id="saveAssessmentBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 mt-4">
          í‰ê°€ ì €ì¥í•˜ê¸°
        </button>
      </div>
      <!-- ì—‘ì…€ ì—…ë¡œë“œ ì„¹ì…˜ -->
      <div id="uploadSection" class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-2xl font-semibold text-indigo-800 mb-4">ì—‘ì…€ íŒŒì¼ ê²€ì¦</h2>
        <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-4">
          <p class="text-sm text-gray-700" id="uploadRangeInfo">âš ï¸ ë¨¼ì € <strong>ì±„ì ê¸°ì¤€ì„ ì„¤ì •</strong>í•œ í›„, ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ì ìˆ˜ë¥¼ ê²€ì¦í•˜ì„¸ìš”.<br>
            ğŸ“‹ <strong>B6:I39 ë²”ìœ„</strong>ì˜ ì…€ë§Œ ê²€ì¦í•©ë‹ˆë‹¤.</p>
        </div>
        <div class="mb-4">
          <label for="fileUpload" id="uploadButton" class="w-full inline-block bg-green-600 hover:bg-green-700 text-white font-semibold py-4 px-6 rounded-lg text-center cursor-pointer transition duration-200 text-lg">
            ğŸ“Š ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ ë° ê²€ì¦
          </label>
          <input type="file" id="fileUpload" accept=".xlsx,.xls" class="hidden">
        </div>
        <div id="fileInfo" class="text-sm text-gray-600"></div>
      </div>
      <!-- ê²€ì¦ ê²°ê³¼ -->
      <div id="resultsSection" class="bg-white rounded-lg shadow-lg p-6 hidden">
        <h2 class="text-2xl font-semibold text-indigo-800 mb-4">ê²€ì¦ ê²°ê³¼</h2>
        <div id="resultsContent"></div>
      </div>
    </div>
    <!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50"></div>
  </div>
<script>
// ------------------- ì„¤ì • ë³€ìˆ˜ --------------------
let allAssessments = [];
let currentAssessmentData = null;
let steps = [];
let possibleTotalScores = [];
let isProcessing = false;

const defaultConfig = {
  page_title: "ìˆ˜í–‰í‰ê°€ ì ìˆ˜ ê²€ì¦",
  upload_button_text: "ğŸ“Š ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ ë° ê²€ì¦",
  background_color: "#EEF2FF",
  surface_color: "#FFFFFF",
  text_color: "#312E81",
  primary_action_color: "#4F46E5",
  secondary_action_color: "#10B981",
  font_family: "Noto Sans KR",
  font_size: 16
};

const dataHandler = {
  onDataChanged(data) {
    allAssessments = data;
    renderSavedAssessments();
  }
};

function getAssessmentMeta() {
  const grade = document.getElementById('gradeSelect').value;
  const classCount = parseInt(document.getElementById('classCountInput').value, 10);
  const studentNum = parseInt(document.getElementById('studentNumInput').value, 10);

  return { grade, classCount, studentNum };
}

function updateRangeInfo() {
  const classCount = parseInt(document.getElementById('classCountInput').value, 10);
  const studentNum = parseInt(document.getElementById('studentNumInput').value, 10);
  let info = "âš ï¸ ë¨¼ì € <strong>ì±„ì ê¸°ì¤€ì„ ì„¤ì •</strong>í•œ í›„, ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ì ìˆ˜ë¥¼ ê²€ì¦í•˜ì„¸ìš”.<br>ğŸ“‹ <strong>";
  if (classCount && studentNum) {
    // ì˜ˆ: B6:I35
    const startCol = 1;
    const endCol = startCol + classCount - 1;
    const startColLetter = XLSX.utils.encode_col(startCol);
    const endColLetter = XLSX.utils.encode_col(endCol);
    const startRow = 6;
    const endRow = 5 + studentNum;
    info += `${startColLetter}${startRow}:${endColLetter}${endRow}`;
  } else {
    info += "B6:I39";
  }
  info += " ë²”ìœ„</strong>ì˜ ì…€ë§Œ ê²€ì¦í•©ë‹ˆë‹¤.";
  document.getElementById('uploadRangeInfo').innerHTML = info;
}
["classCountInput", "studentNumInput"].forEach(id=>{
  document.getElementById(id).addEventListener('input', updateRangeInfo);
});
updateRangeInfo();

async function onConfigChange(config) {
  const bgColor = config.background_color || defaultConfig.background_color;
  const surfaceColor = config.surface_color || defaultConfig.surface_color;
  const textColor = config.text_color || defaultConfig.text_color;
  const primaryColor = config.primary_action_color || defaultConfig.primary_action_color;
  const secondaryColor = config.secondary_action_color || defaultConfig.secondary_action_color;
  const fontFamily = config.font_family || defaultConfig.font_family;
  const fontSize = config.font_size || defaultConfig.font_size;

  document.body.style.fontFamily = `${fontFamily}, 'Noto Sans KR', sans-serif`;
  document.getElementById('app').style.background = `linear-gradient(to bottom right, ${bgColor}, ${bgColor}dd)`;

  const surfaces = document.querySelectorAll('.bg-white');
  surfaces.forEach(s => s.style.backgroundColor = surfaceColor);

  document.getElementById('pageTitle').textContent = config.page_title || defaultConfig.page_title;
  document.getElementById('pageTitle').style.color = textColor;
  document.getElementById('pageTitle').style.fontSize = `${fontSize * 2}px`;

  const headings = document.querySelectorAll('h2');
  headings.forEach(h => {
    h.style.color = textColor;
    h.style.fontSize = `${fontSize * 1.5}px`;
  });

  const uploadLabel = document.getElementById('uploadButton');
  uploadLabel.innerHTML = config.upload_button_text || defaultConfig.upload_button_text;
  uploadLabel.style.backgroundColor = secondaryColor;
  uploadLabel.style.fontSize = `${fontSize * 1.1}px`;
}

function renderSavedAssessments() {
  const listEl = document.getElementById('savedAssessmentsList');
  const emptyEl = document.getElementById('emptyAssessments');

  if (allAssessments.length === 0) {
    listEl.innerHTML = '';
    emptyEl.classList.remove('hidden');
    return;
  }

  emptyEl.classList.add('hidden');
  listEl.innerHTML = allAssessments.map(assessment => {
    const stepsData = JSON.parse(assessment.steps_data);
    return `
      <div class="border-2 border-gray-200 rounded-lg p-4 flex justify-between items-start hover:border-indigo-300 transition">
        <div class="flex-1">
          <div class="font-bold text-lg text-indigo-900">${escapeHtml(assessment.subject)} - ${escapeHtml(assessment.assessment_name)}</div>
          <div class="text-sm text-gray-600 mt-1">${stepsData.steps.length}ê°œ ë‹¨ê³„ | ê°€ëŠ¥í•œ ì´ì : ${stepsData.possibleScores.length}ê°œ</div>
          <div class="text-xs text-gray-500 mt-1">
            í•™ë…„: ${stepsData.grade || '?'} | ë°˜: ${stepsData.classCount || '?'} | ë²ˆí˜¸: ${stepsData.studentNum || '?'}
          </div>
        </div>
        <div class="flex gap-2">
          <button onclick="loadAssessment('${assessment.__backendId}')"
            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm transition duration-200">
            ë¶ˆëŸ¬ì˜¤ê¸°
          </button>
          <button onclick="deleteAssessment('${assessment.__backendId}')"
            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm transition duration-200">
            ì‚­ì œ
          </button>
        </div>
      </div>
    `;
  }).join('');
}

async function deleteAssessment(id) {
  if (isProcessing) return;

  const assessment = allAssessments.find(a => a.__backendId === id);
  if (!assessment) return;

  isProcessing = true;
  const result = await window.dataSdk.delete(assessment);
  isProcessing = false;

  if (result.isOk) {
    showToast('í‰ê°€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    if (currentAssessmentData && currentAssessmentData.__backendId === id) {
      resetCurrentAssessment();
    }
  } else {
    showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
  }
}

function loadAssessment(id) {
  const assessment = allAssessments.find(a => a.__backendId === id);
  if (!assessment) return;

  const stepsData = JSON.parse(assessment.steps_data);

  currentAssessmentData = assessment;
  steps = stepsData.steps;
  possibleTotalScores = stepsData.possibleScores;

  document.getElementById('subjectSelect').value = assessment.subject;
  document.getElementById('assessmentInput').value = assessment.assessment_name;
  if (stepsData.grade) document.getElementById('gradeSelect').value = stepsData.grade;
  if (stepsData.classCount) document.getElementById('classCountInput').value = stepsData.classCount;
  if (stepsData.studentNum) document.getElementById('studentNumInput').value = stepsData.studentNum;

  showCurrentAssessment();
  updateStepsList();
  calculatePossibleScores();

  document.getElementById('criteriaSection').classList.remove('hidden');

  showToast('í‰ê°€ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!', 'success');
}

document.getElementById('newAssessmentBtn').addEventListener('click', function() {
  const subject = document.getElementById('subjectSelect').value;
  const assessmentName = document.getElementById('assessmentInput').value.trim();
  const {grade, classCount, studentNum} = getAssessmentMeta();
  if (!subject || !assessmentName || !grade || !classCount || !studentNum) {
    showToast('ê³¼ëª©, ìˆ˜í–‰í‰ê°€ëª…, í•™ë…„, ë°˜ ìˆ˜, ë²ˆí˜¸ ìˆ˜ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”!', 'error');
    return;
  }

  currentAssessmentData = null;
  steps = [];
  possibleTotalScores = [];

  showCurrentAssessment();
  updateStepsList();
  document.getElementById('possibleScores').innerHTML = '';

  document.getElementById('criteriaSection').classList.remove('hidden');
  document.getElementById('resultsSection').classList.add('hidden');

  showToast('ìƒˆ í‰ê°€ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤!', 'success');
});

document.getElementById('loadAssessmentBtn').addEventListener('click', function() {
  const subject = document.getElementById('subjectSelect').value;
  const assessmentName = document.getElementById('assessmentInput').value.trim();

  if (!subject || !assessmentName) {
    showToast('ê³¼ëª©ê³¼ ìˆ˜í–‰í‰ê°€ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'error');
    return;
  }

  const found = allAssessments.find(a =>
    a.subject === subject && a.assessment_name === assessmentName
  );

  if (found) {
    loadAssessment(found.__backendId);
  } else {
    showToast('í•´ë‹¹ í‰ê°€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
  }
});

function showCurrentAssessment() {
  const subject = document.getElementById('subjectSelect').value;
  const assessmentName = document.getElementById('assessmentInput').value.trim();

  if (subject && assessmentName) {
    document.getElementById('currentAssessment').classList.remove('hidden');
    document.getElementById('currentAssessmentTitle').textContent = `${subject} - ${assessmentName}`;

    const status = currentAssessmentData ? 'ì €ì¥ëœ í‰ê°€ ìˆ˜ì • ì¤‘' : 'ìƒˆ í‰ê°€ ì‘ì„± ì¤‘';
    document.getElementById('currentAssessmentInfo').textContent = status;
  }
}

function resetCurrentAssessment() {
  currentAssessmentData = null;
  steps = [];
  possibleTotalScores = [];
  document.getElementById('subjectSelect').value = '';
  document.getElementById('assessmentInput').value = '';
  document.getElementById('gradeSelect').value = '';
  document.getElementById('classCountInput').value = '';
  document.getElementById('studentNumInput').value = '';
  document.getElementById('currentAssessment').classList.add('hidden');
  document.getElementById('criteriaSection').classList.add('hidden');
  document.getElementById('resultsSection').classList.add('hidden');
  updateStepsList();
}

document.getElementById('addStepBtn').addEventListener('click', function() {
  const maxScore = parseFloat(document.getElementById('maxScore').value);
  const minScore = parseFloat(document.getElementById('minScore').value);
  const interval = parseFloat(document.getElementById('interval').value);

  if (isNaN(maxScore) || isNaN(minScore) || isNaN(interval) || maxScore < 0 || minScore < 0 || interval <= 0) {
    showToast('ìµœê³ ì , ìµœì €ì , ê¸‰ê°„ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'error');
    return;
  }

  if (minScore > maxScore) {
    showToast('ìµœì €ì ì€ ìµœê³ ì ë³´ë‹¤ í´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!', 'error');
    return;
  }

  const scores = [];
  for (let score = maxScore; score >= minScore; score -= interval) {
    scores.push(score);
  }
  if (!scores.includes(minScore)) {
    scores.push(minScore);
  }

  const stepNumber = steps.length + 1;
  const stepName = stepNumber.toString();

  steps.push({
    id: Date.now(),
    name: stepName,
    maxScore,
    minScore,
    interval,
    scores: scores.sort((a, b) => b - a)
  });

  document.getElementById('maxScore').value = '';
  document.getElementById('minScore').value = '';
  document.getElementById('interval').value = '';

  updateStepsList();
  calculatePossibleScores();
  showToast(`${stepNumber}ë‹¨ê³„ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
});

function updateStepsList() {
  const listEl = document.getElementById('stepsList');

  if (steps.length === 0) {
    listEl.innerHTML = '<div class="text-gray-500 text-center py-4">ë“±ë¡ëœ ë‹¨ê³„ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  listEl.innerHTML = steps.map((step, index) => `
    <div class="bg-indigo-50 border-2 border-indigo-200 rounded-lg p-4 flex justify-between items-start">
      <div class="flex-1">
        <div class="font-bold text-lg text-indigo-900">${index + 1}ë‹¨ê³„</div>
        <div class="text-sm text-gray-700 mt-1">
          ìµœê³ ì : <strong>${step.maxScore}ì </strong> | ìµœì €ì : <strong>${step.minScore}ì </strong> | ê¸‰ê°„: <strong>${step.interval}ì </strong>
        </div>
        <div class="text-xs text-gray-600 mt-2">
          ê°€ëŠ¥í•œ ì ìˆ˜: ${step.scores.join(', ')}
        </div>
      </div>
      <button onclick="deleteStep(${step.id})"
        class="ml-4 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition duration-200">
        ì‚­ì œ
      </button>
    </div>
  `).join('');
}

function deleteStep(id) {
  steps = steps.filter(s => s.id !== id);
  updateStepsList();
  calculatePossibleScores();
  showToast('ë‹¨ê³„ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

function calculatePossibleScores() {
  const scoresEl = document.getElementById('possibleScores');

  if (steps.length === 0) {
    scoresEl.innerHTML = '';
    possibleTotalScores = [];
    return;
  }

  const allCombinations = cartesianProduct(steps.map(s => s.scores));
  const totalScores = allCombinations.map(combo => combo.reduce((sum, score) => sum + score, 0));
  possibleTotalScores = [...new Set(totalScores)].sort((a, b) => b - a);

  scoresEl.innerHTML = `
    <div class="bg-green-50 border-2 border-green-300 rounded-lg p-4">
      <div class="font-bold text-lg text-green-900 mb-2">
        ê°€ëŠ¥í•œ ì´ì  (${possibleTotalScores.length}ê°œ)
      </div>
      <div class="text-sm text-gray-700 leading-relaxed">
        ${possibleTotalScores.join(', ')}
      </div>
      <div class="text-xs text-gray-600 mt-2">
        ìµœê³ ì : ${Math.max(...possibleTotalScores)}ì  | ìµœì €ì : ${Math.min(...possibleTotalScores)}ì 
      </div>
    </div>
  `;
}

function cartesianProduct(arrays) {
  if (arrays.length === 0) return [[]];
  if (arrays.length === 1) return arrays[0].map(x => [x]);
  const [first, ...rest] = arrays;
  const restProduct = cartesianProduct(rest);
  return first.flatMap(x =>
    restProduct.map(combination => [x, ...combination])
  );
}

document.getElementById('saveAssessmentBtn').addEventListener('click', async function() {
  if (isProcessing) return;
  if (allAssessments.length >= 999 && !currentAssessmentData) {
    showToast('ìµœëŒ€ 999ê°œê¹Œì§€ë§Œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
    return;
  }

  const subject = document.getElementById('subjectSelect').value;
  const assessmentName = document.getElementById('assessmentInput').value.trim();
  const {grade, classCount, studentNum} = getAssessmentMeta();
  if (!subject || !assessmentName || !grade || !classCount || !studentNum) {
    showToast('ê³¼ëª©, ìˆ˜í–‰í‰ê°€ëª…, í•™ë…„, ë°˜ ìˆ˜, ë²ˆí˜¸ ìˆ˜ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”!', 'error');
    return;
  }

  if (steps.length === 0) {
    showToast('ìµœì†Œ 1ê°œ ì´ìƒì˜ ë‹¨ê³„ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”!', 'error');
    return;
  }

  isProcessing = true;
  const btn = document.getElementById('saveAssessmentBtn');
  const originalText = btn.textContent;
  btn.textContent = 'ì €ì¥ ì¤‘...';
  btn.disabled = true;

  const stepsData = JSON.stringify({
    steps: steps,
    possibleScores: possibleTotalScores,
    grade, classCount, studentNum
  });

  let result;
  if (currentAssessmentData) {
    const updatedData = {
      ...currentAssessmentData,
      subject,
      assessment_name: assessmentName,
      steps_data: stepsData
    };
    result = await window.dataSdk.update(updatedData);
  } else {
    result = await window.dataSdk.create({
      id: Date.now().toString(),
      subject,
      assessment_name: assessmentName,
      steps_data: stepsData,
      created_at: new Date().toISOString()
    });
  }

  btn.textContent = originalText;
  btn.disabled = false;
  isProcessing = false;

  if (result.isOk) {
    showToast('í‰ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
  } else {
    showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
  }
});

document.getElementById('fileUpload').addEventListener('change', handleFileUpload);

async function handleFileUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  const {grade, classCount, studentNum} = getAssessmentMeta();
  if (possibleTotalScores.length === 0) {
    showToast('ë¨¼ì € ë‹¨ê³„ë³„ ì±„ì ê¸°ì¤€ì„ ì„¤ì •í•´ì£¼ì„¸ìš”!', 'error');
    e.target.value = '';
    return;
  }
  if (!grade || !classCount || !studentNum) {
    showToast('í•™ë…„, ë°˜ ìˆ˜, ë²ˆí˜¸ ìˆ˜ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”!', 'error');
    e.target.value = '';
    return;
  }
  document.getElementById('fileInfo').innerHTML = `<span class="text-blue-600">íŒŒì¼ ${file.name} ê²€ì¦ ì¤‘...</span>`;
  document.getElementById('resultsSection').classList.add('hidden');

  try {
    // ë™ì ìœ¼ë¡œ ê²€ì‚¬ ë²”ìœ„ ì§€ì •
    const data = await readExcelFile(file, classCount, studentNum);
    validateData(data, file.name, grade, classCount, studentNum);
  } catch (error) {
    console.error('ì—‘ì…€ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
    showToast('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    document.getElementById('fileInfo').innerHTML = '<span class="text-red-600">íŒŒì¼ ì½ê¸° ì‹¤íŒ¨</span>';
  }
  e.target.value = '';
}

function readExcelFile(file, classCount, studentNum) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });

        if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
          reject(new Error('ì—‘ì…€ íŒŒì¼ì— ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.'));
          return;
        }
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        // "B"~(B+classCount-1), 6~(5+studentNum) ë²”ìœ„ë¡œ
        const startCol = 1; // B=col 1 ('A'=0)
        const endCol = startCol + classCount - 1;
        const startRow = 6;
        const endRow = 5 + studentNum;
        const range = {
          s: {c: startCol, r: startRow - 1},
          e: {c: endCol, r: endRow - 1}
        };

        const rangeData = [];
        for (let row = range.s.r; row <= range.e.r; row++) {
          const rowData = {};
          for (let col = range.s.c; col <= range.e.c; col++) {
            const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
            const cell = firstSheet[cellAddress];
            const columnLetter = XLSX.utils.encode_col(col);
            const actualRow = row + 1;

            rowData[columnLetter] = cell ? cell.v : '';
            rowData._row = actualRow;
            rowData._col = col;
          }
          rangeData.push(rowData);
        }
        if (rangeData.length === 0) {
          reject(new Error('ì„¤ì •í•œ ë²”ìœ„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'));
          return;
        }
        resolve(rangeData);
      } catch (error) {
        reject(error);
      }
    };
    reader.onerror = () => reject(new Error('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'));
    reader.readAsArrayBuffer(file);
  });
}
function makeStudentId(grade, colIdx, rowIdx, classCount, studentNum) {
  const ban = String(colIdx + 1);
  let bunho = rowIdx + 1;
  // ê²°ë²ˆ ë“± íŠ¹ë³„ ì˜ˆì™¸ í•„ìš”í•˜ë©´ ì—¬ê¸°ì— ì ìš©
  if (bunho > studentNum) return null; // ì—†ëŠ” ë²ˆí˜¸ë¼ë©´ í‘œì‹œì•ˆí•¨
  return `${grade}${ban}${String(bunho).padStart(2,'0')}`;
}

function validateData(data, fileName, grade, classCount, studentNum) {
  const errors = [];
  let totalChecked = 0;
  data.forEach((row, rowIdx) => {
    const actualRow = row._row;

    for (const [columnName, value] of Object.entries(row)) {
      if (columnName === '_row' || columnName === '_col') continue;
      if (value === '' || value === null || value === undefined) continue;

      const scoreStr = String(value).trim();
      const scoreNum = parseFloat(scoreStr);

      if (isNaN(scoreNum)) continue;

      totalChecked++;

      if (!possibleTotalScores.includes(scoreNum)) {
        const cellAddress = `${columnName}${actualRow}`;
        const colIdx = columnName.charCodeAt(0) - 66;
        const studentId = makeStudentId(grade, colIdx, rowIdx, classCount, studentNum);
        errors.push({
          cell: cellAddress,
          column: columnName,
          row: actualRow,
          value: scoreStr,
          colIdx,
          rowIdx,
          studentId
        });
      }
    }
  });

  displayResults(errors, data.length, totalChecked, fileName, grade, classCount, studentNum);

  if (errors.length === 0) {
    document.getElementById('fileInfo').innerHTML = `<span class="text-green-600">âœ… ${fileName}: ${totalChecked}ê°œ ì ìˆ˜ ê²€ì¦ ì™„ë£Œ (ì˜¤ë¥˜ ì—†ìŒ)</span>`;
  } else {
    document.getElementById('fileInfo').innerHTML = `<span class="text-red-600">âš ï¸ ${fileName}: ${errors.length}ê°œ ì˜¤ë¥˜ ë°œê²¬</span>`;
  }
}

function displayResults(errors, totalRows, totalChecked, fileName, grade, classCount, studentNum) {
  const resultsSection = document.getElementById('resultsSection');
  const resultsContent = document.getElementById('resultsContent');

  resultsSection.classList.remove('hidden');

  const subject = document.getElementById('subjectSelect').value;
  const assessmentName = document.getElementById('assessmentInput').value.trim();

  if (errors.length === 0) {
    resultsContent.innerHTML = `
      <div class="bg-white border-4 border-green-500 rounded-lg p-8 print:border-2">
        <div class="text-center mb-6 pb-4 border-b-2 border-gray-300">
          <h3 class="text-3xl font-bold text-gray-800 mb-2">${escapeHtml(subject)} - ${escapeHtml(assessmentName)}</h3>
          <p class="text-xl text-gray-600">ê²€ì¦ ê²°ê³¼ ë³´ê³ ì„œ</p>
        </div>
        <div class="bg-green-50 border-2 border-green-300 rounded-lg p-6 mb-6">
          <h4 class="text-xl font-bold text-green-800 mb-3">âœ… ê²€ì¦ ì„±ê³µ!</h4>
          <p class="text-lg text-gray-700">
            ì—‘ì…€ì—ì„œ <strong class="text-green-700">${totalChecked}ê°œ ì ìˆ˜</strong>ë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤.<br>
            ëª¨ë“  ì ìˆ˜ê°€ ì±„ì ê¸°ì¤€ì— ë¶€í•©í•©ë‹ˆë‹¤.
          </p>
        </div>
        <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-6">
          <h4 class="text-lg font-bold text-blue-800 mb-3">ğŸ“Š ê°€ëŠ¥í•œ ì´ì </h4>
          <p class="text-base text-gray-700 leading-relaxed">
            ${possibleTotalScores.join(', ')}
          </p>
        </div>
        <div class="text-center mt-6 pt-6 border-t-2 border-gray-300 flex gap-3 justify-center">
          <button onclick="copyResultsTable()"
            class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg transition duration-200 print:hidden">
            ğŸ“‹ í‘œ í˜•ì‹ìœ¼ë¡œ ë³µì‚¬
          </button>
          <button onclick="window.print()"
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-8 rounded-lg transition duration-200 print:hidden">
            ğŸ–¨ï¸ ì¸ì‡„ / PDF ì €ì¥
          </button>
        </div>
      </div>
    `;
  } else {
    resultsContent.innerHTML = `
      <div class="bg-white border-4 border-red-500 rounded-lg p-8 print:border-2">
        <div class="text-center mb-6 pb-4 border-b-2 border-gray-300">
          <h3 class="text-3xl font-bold text-gray-800 mb-2">${escapeHtml(subject)} - ${escapeHtml(assessmentName)}</h3>
          <p class="text-xl text-gray-600">ê²€ì¦ ê²°ê³¼ ë³´ê³ ì„œ</p>
        </div>
        <div class="bg-red-50 border-2 border-red-300 rounded-lg p-6 mb-6">
          <h4 class="text-xl font-bold text-red-800 mb-3">âš ï¸ ì˜¤ë¥˜ ë°œê²¬</h4>
          <p class="text-lg text-gray-700">
            ì´ <strong class="text-red-700">${totalChecked}ê°œ ì ìˆ˜</strong> ì¤‘ <strong class="text-red-700">${errors.length}ê°œ ì˜¤ë¥˜</strong>ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.
          </p>
        </div>
        <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-6 mb-6">
          <h4 class="text-lg font-bold text-blue-800 mb-3">ğŸ“Š ê°€ëŠ¥í•œ ì´ì </h4>
          <p class="text-base text-gray-700 leading-relaxed">
            ${possibleTotalScores.join(', ')}
          </p>
        </div>
        <div class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-6 mb-6">
          <h4 class="text-xl font-bold text-red-800 mb-4">âŒ ì˜¤ë¥˜ ìƒì„¸ ë‚´ì—­ (${errors.length}ê°œ)</h4>
          <div class="space-y-3">
            ${errors.map(err => {
              const studentId = err.studentId;
              return `
                <div class="bg-white border-l-4 border-red-500 px-5 py-4 rounded shadow-sm">
                  <div class="flex items-center gap-4 text-base">
                    <span class="font-bold text-gray-700 min-w-[80px]">ì…€ ${escapeHtml(err.cell)}</span>
                    ${studentId ? `<span class="text-gray-600">í•™ë²ˆ ${studentId}</span>` : ''}
                    <span class="bg-red-100 px-3 py-1 rounded font-mono text-red-700 font-bold">${escapeHtml(err.value)}ì </span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
        <div class="text-center mt-6 pt-6 border-t-2 border-gray-300 flex gap-3 justify-center">
          <button onclick="copyResultsTable()"
            class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg transition duration-200 print:hidden">
            ğŸ“‹ í‘œ í˜•ì‹ìœ¼ë¡œ ë³µì‚¬
          </button>
          <button onclick="window.print()"
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-8 rounded-lg transition duration-200 print:hidden">
            ğŸ–¨ï¸ ì¸ì‡„ / PDF ì €ì¥
          </button>
        </div>
      </div>
    `;
  }
}

function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
  toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg mb-2 transition-all duration-300 transform`;
  toast.textContent = message;
  container.appendChild(toast);

  setTimeout(() => toast.classList.add('opacity-0'), 2500);
  setTimeout(() => toast.remove(), 3000);
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function copyResultsTable() {
  const subject = document.getElementById('subjectSelect').value;
  const assessmentName = document.getElementById('assessmentInput').value.trim();
  const possibleScoresStr = possibleTotalScores.join(', ');

  const resultsContent = document.getElementById('resultsContent');
  const errorDivs = resultsContent.querySelectorAll('.bg-yellow-50 .bg-white');

  let tableText = `ê³¼ëª©\tìˆ˜í–‰í‰ê°€ëª…\tê°€ëŠ¥í•œ ì´ì \n`;
  tableText += `${subject}\t${assessmentName}\t${possibleScoresStr}\n\n`;

  if (errorDivs.length > 0) {
    tableText += `ì˜¤ë¥˜ ìƒì„¸ ë‚´ì—­\n`;
    tableText += `í•™ë²ˆ\tì ìˆ˜\n`;
    errorDivs.forEach(div => {
      const text = div.textContent.trim();
      const studentIdMatch = text.match(/í•™ë²ˆ\s+(\d+)/);
      const scoreMatch = text.match(/(\d+(?:\.\d+)?)ì /);
      if (studentIdMatch && scoreMatch) {
        const studentId = studentIdMatch[1];
        const score = scoreMatch[1];
        tableText += `${studentId}\t${score}\n`;
      }
    });
  } else {
    tableText += `ì˜¤ë¥˜ ì—†ìŒ\n`;
  }

  // ì„ì‹œ í…ìŠ¤íŠ¸ ì˜ì—­ ìƒì„±í•˜ì—¬ ë³µì‚¬
  const textarea = document.createElement('textarea');
  textarea.value = tableText;
  textarea.style.position = 'fixed';
  textarea.style.opacity = '0';
  document.body.appendChild(textarea);
  textarea.select();

  try {
    document.execCommand('copy');
    showToast('í‘œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
  } catch (err) {
    showToast('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
  } finally {
    document.body.removeChild(textarea);
  }
}

async function init() {
  const initResult = await window.dataSdk.init(dataHandler);
  if (!initResult.isOk) {
    showToast('ë°ì´í„° ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
  }

  if (window.elementSdk) {
    window.elementSdk.init({
      defaultConfig,
      onConfigChange,
      mapToCapabilities: (config) => ({
        recolorables: [
          { get: () => config.background_color || defaultConfig.background_color, set: (v) => { config.background_color = v; window.elementSdk.setConfig({ background_color: v }); } },
          { get: () => config.surface_color || defaultConfig.surface_color, set: (v) => { config.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); } },
          { get: () => config.text_color || defaultConfig.text_color, set: (v) => { config.text_color = v; window.elementSdk.setConfig({ text_color: v }); } },
          { get: () => config.primary_action_color || defaultConfig.primary_action_color, set: (v) => { config.primary_action_color = v; window.elementSdk.setConfig({ primary_action_color: v }); } },
          { get: () => config.secondary_action_color || defaultConfig.secondary_action_color, set: (v) => { config.secondary_action_color = v; window.elementSdk.setConfig({ secondary_action_color: v }); } }
        ],
        borderables: [],
        fontEditable: {
          get: () => config.font_family || defaultConfig.font_family,
          set: (v) => { config.font_family = v; window.elementSdk.setConfig({ font_family: v }); }
        },
        fontSizeable: {
          get: () => config.font_size || defaultConfig.font_size,
          set: (v) => { config.font_size = v; window.elementSdk.setConfig({ font_size: v }); }
        }
      }),
      mapToEditPanelValues: (config) => new Map([
        ["page_title", config.page_title || defaultConfig.page_title],
        ["upload_button_text", config.upload_button_text || defaultConfig.upload_button_text]
      ])
    });
  }
}

init();
</script>
</body>
</html>
